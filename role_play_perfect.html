<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê√≥ng Vai H·ªôi Tho·∫°i</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; padding: 20px; text-align: center; }
    .card, .translation, .hint, .feedback, .fade { transition: opacity 0.5s ease-in-out; }
    .card { background: #2b2d42; padding: 20px; border-radius: 12px; margin: 20px auto; max-width: 700px; font-size: 20px; }
    select, button, input[type="radio"], input[type="text"], label { margin: 10px; padding: 10px; font-size: 16px; }
    .translation { font-style: italic; color: #a0e0f0; margin-top: 10px; }
    .hint { color: #ffd166; margin: 10px auto; font-style: italic; font-size: 18px; }
    .correct { color: #4cc9f0; font-weight: bold; }
    .wrong { color: #f72585; font-weight: bold; }
    .hidden { opacity: 0; pointer-events: none; height: 0; overflow: hidden; }
    .visible { opacity: 1; }
    .mic-status { margin: 10px; font-style: italic; }
    .prompt-message { color: #8ac926; font-style: italic; margin: 15px 0; font-size: 18px; }
    .vietnamese-prompt { color: #f8f9fa; font-weight: bold; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üé≠ ƒê√≥ng Vai H·ªôi Tho·∫°i</h1>
  <div>
    <select id="lessonSelector"></select>
    <button onclick="loadLesson()">üì• T·∫£i B√†i H·ªçc</button><br>
    <label><input type="radio" name="role" value="answer" checked> T√¥i l√† Ng∆∞·ªùi tr·∫£ l·ªùi</label>
    <label><input type="radio" name="role" value="ask"> T√¥i l√† Ng∆∞·ªùi h·ªèi</label><br>
    <label><input type="checkbox" id="hidePrompts" onchange="togglePrompts()"> ·∫®n G·ª£i √ù v√† C√¢u Tho·∫°i</label><br>
    <button onclick="startRolePlay()">üé¨ B·∫Øt ƒë·∫ßu ƒê√≥ng Vai</button>
  </div>
  <div class="card fade" id="dialogueDisplay">C√¢u tho·∫°i s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y.</div>
  <div id="translation" class="translation fade"></div>
  <div id="hint" class="hint fade"></div>
  <div id="vietnamesePrompt" class="vietnamese-prompt"></div>
  <div id="promptMessage" class="prompt-message"></div>
  <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi ho·∫∑c n√≥i..." onkeydown="if(event.key==='Enter') checkAnswer()">
  <button onclick="checkAnswer()">Ki·ªÉm tra</button>
  <button id="micButton" onclick="toggleMic()">üé§ B·∫≠t Microphone</button>
  <div id="micStatus" class="mic-status">Microphone: T·∫Øt</div>
  <div id="feedback" class="feedback"></div>

<script>
let lessonData = [];
let mappingData = [];
let lessons = [];
let currentIndex = 0;
let role = "answer";
let expectedText = "";
let recognition = null;
let isMicActive = false;
let isPlayingAudio = false;

function togglePrompts() {
  const hide = document.getElementById("hidePrompts").checked;
  ["dialogueDisplay", "translation", "hint", "promptMessage", "vietnamesePrompt"].forEach(id => {
    const el = document.getElementById(id);
    el.className = hide ? "hidden" : 
      id === "promptMessage" ? "prompt-message" : 
      id === "vietnamesePrompt" ? "vietnamese-prompt" : "fade visible";
  });
}

function loadLesson() {
  const selected = document.getElementById("lessonSelector").value;
  const lesson = lessons.find(l => l.name === selected);
  if (!lesson) return alert("Kh√¥ng t√¨m th·∫•y b√†i h·ªçc!");

  Promise.all([
    fetch("LESSON/" + lesson.name).then(res => res.json()),
    fetch("LESSON/" + lesson.mapping).then(res => res.json())
  ]).then(([data, mapping]) => {
    lessonData = data;
    mappingData = Array.isArray(mapping) ? mapping : [mapping];
    document.getElementById("dialogueDisplay").innerText = "‚úÖ B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i. Ch·ªçn ch·∫ø ƒë·ªô v√† nh·∫•n b·∫Øt ƒë·∫ßu.";
  }).catch(err => {
    alert("‚ùå Kh√¥ng th·ªÉ t·∫£i b√†i h·ªçc ho·∫∑c mapping.");
    console.error(err);
  });
}

function startRolePlay() {
  role = document.querySelector('input[name="role"]:checked').value;
  currentIndex = 0;
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("promptMessage").innerHTML = "";
  document.getElementById("vietnamesePrompt").innerHTML = "";
  togglePrompts();
  nextDialogue();
}

function nextDialogue() {
  if (currentIndex >= lessonData.length) {
    document.getElementById("dialogueDisplay").innerText = "‚úÖ Ho√†n t·∫•t ƒëo·∫°n h·ªôi tho·∫°i.";
    document.getElementById("translation").innerText = "";
    document.getElementById("hint").innerText = "";
    document.getElementById("promptMessage").innerText = "";
    document.getElementById("vietnamesePrompt").innerText = "";
    stopMic();
    return;
  }

  const item = lessonData[currentIndex];
  let text, translation, hintText, vietnamesePrompt;

  if (role === "answer") {
    // Ch·∫ø ƒë·ªô ng∆∞·ªùi tr·∫£ l·ªùi
    text = item[0]; 
    translation = item[2]; 
    expectedText = item[3];
    hintText = "üëâ B·∫°n c·∫ßn tr·∫£ l·ªùi: " + item[5];
    vietnamesePrompt = "";
  } else {
    // Ch·∫ø ƒë·ªô ng∆∞·ªùi h·ªèi
    text = item[3]; 
    translation = item[5]; 
    expectedText = item[0];
    hintText = "";
    vietnamesePrompt = "üí¨ H√£y h·ªèi: " + item[2]; // Hi·ªÉn th·ªã c√¢u h·ªèi ti·∫øng Vi·ªát
  }

  document.getElementById("dialogueDisplay").innerText = text;
  document.getElementById("translation").innerText = role === "answer" ? "üí¨ " + translation : "";
  document.getElementById("hint").innerText = hintText;
  document.getElementById("vietnamesePrompt").innerText = vietnamesePrompt;
  document.getElementById("userInput").value = "";
  document.getElementById("userInput").focus();

  if (role === "answer") {
    // Ch·∫ø ƒë·ªô ng∆∞·ªùi tr·∫£ l·ªùi: ph√°t √¢m thanh c√¢u h·ªèi
    isPlayingAudio = true;
    document.getElementById("promptMessage").innerText = "";
    playAudio(text, () => {
      isPlayingAudio = false;
      if (isMicActive) {
        startMic();
      }
    });
  } else {
    // Ch·∫ø ƒë·ªô ng∆∞·ªùi h·ªèi: ch·ªâ hi·ªÉn th·ªã prompt ti·∫øng Vi·ªát
    isPlayingAudio = false;
    document.getElementById("promptMessage").innerText = "üîä H√£y n√≥i b·∫±ng ti·∫øng Anh";
    if (isMicActive) {
      startMic();
    }
  }
}

function playAudio(text, callback) {
  const audio = mappingData.find(a => a.text === text);
  if (!audio) {
    if (callback) callback();
    return;
  }
  
  const sound = new Howl({ 
    src: ["LESSON/" + audio.file], 
    html5: true,
    onend: callback
  });
  sound.play();
}

function toggleMic() {
  if (isMicActive) {
    stopMic();
  } else {
    startMic();
  }
}

function startMic() {
  if (isPlayingAudio) return;
  
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    recognition.onresult = function(event) {
      const result = event.results[0][0].transcript.trim();
      document.getElementById("userInput").value = result;
      checkAnswer(); // T·ª± ƒë·ªông ki·ªÉm tra khi c√≥ k·∫øt qu·∫£
    };
    
    recognition.onerror = function(event) {
      console.log("Speech recognition error", event.error);
      document.getElementById("micStatus").innerText = "Microphone: L·ªói - " + event.error;
    };
    
    recognition.onend = function() {
      if (isMicActive) {
        recognition.start();
      }
    };
    
    recognition.start();
    isMicActive = true;
    document.getElementById("micStatus").innerText = "Microphone: ƒêang ho·∫°t ƒë·ªông";
    document.getElementById("micButton").innerText = "üé§ T·∫Øt Microphone";
  } else {
    alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i.");
  }
}

function stopMic() {
  if (recognition) {
    recognition.stop();
  }
  isMicActive = false;
  document.getElementById("micStatus").innerText = "Microphone: T·∫Øt";
  document.getElementById("micButton").innerText = "üé§ B·∫≠t Microphone";
}

function checkAnswer() {
  const userInput = document.getElementById("userInput").value.toLowerCase().trim();
  const correct = expectedText.toLowerCase().trim();
  const score = compareText(correct, userInput);
  const feedback = document.getElementById("feedback");

  if (score >= 80) {
    feedback.innerHTML = `<div class='correct'>‚úÖ ƒê√∫ng! (${score}%)</div>`;
    // Ph√°t c√¢u tr·∫£ l·ªùi n·∫øu l√† ch·∫ø ƒë·ªô ng∆∞·ªùi h·ªèi
    if (role === "ask") {
      const answerText = lessonData[currentIndex][3]; // L·∫•y c√¢u tr·∫£ l·ªùi t·ª´ d·ªØ li·ªáu
      isPlayingAudio = true;
      playAudio(answerText, () => {
        isPlayingAudio = false;
        setTimeout(() => {
          currentIndex++;
          feedback.innerHTML = "";
          nextDialogue();
        }, 1000);
      });
    } else {
      setTimeout(() => {
        currentIndex++;
        feedback.innerHTML = "";
        nextDialogue();
      }, 1000);
    }
  } else {
    feedback.innerHTML = `<div class='wrong'>‚ùå Ch∆∞a ch√≠nh x√°c (${score}%)<br>ƒê√°p √°n ƒë√∫ng: ${expectedText}</div>`;
    // N·∫øu sai, v·∫´n ph√°t c√¢u tr·∫£ l·ªùi khi l√† ng∆∞·ªùi h·ªèi
    if (role === "ask") {
      const answerText = lessonData[currentIndex][3];
      isPlayingAudio = true;
      playAudio(answerText, () => {
        isPlayingAudio = false;
        setTimeout(() => {
          currentIndex++;
          feedback.innerHTML = "";
          nextDialogue();
        }, 1000);
      });
    }
  }
}

function compareText(a, b) {
  let matrix = Array(a.length+1).fill(null).map(()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++)matrix[i][0]=i;
  for(let j=0;j<=b.length;j++)matrix[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      matrix[i][j]=a[i-1]==b[j-1]?matrix[i-1][j-1]:1+Math.min(matrix[i-1][j],matrix[i][j-1],matrix[i-1][j-1]);
    }
  }
  const distance = matrix[a.length][b.length];
  const maxLen = Math.max(a.length, b.length);
  return Math.round(100 - (distance / maxLen) * 100);
}

window.onload = function() {
  fetch("json_list.json")
    .then(res => res.json())
    .then(data => {
      lessons = data.lessons || [];
      const selector = document.getElementById("lessonSelector");
      lessons.forEach(lesson => {
        const opt = document.createElement("option");
        opt.value = lesson.name;
        opt.innerText = lesson.name.replace(".json", "");
        selector.appendChild(opt);
      });
    });
};
</script>
</body>
</html>